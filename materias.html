<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matéria-Prima</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-dark text-white">
  <nav class="navbar fixed-top bg-black">
    <div class="container-fluid">
      <a class="navbar-brand text-danger fs-4" href="dashboard.html">Injetoras PRO</a>
    </div>
  </nav>

  <div class="container mt-5 pt-4">
    <h2 class="text-center">Matéria-Prima</h2>
    <div class="card bg-secondary p-4 mb-4">
      <div class="row g-3">
        <div class="col-md-3"><input type="text" id="nome" class="form-control" placeholder="Nome"></div>
        <div class="col-md-2"><select id="tipo" class="form-select"><option>Virgem</option><option>Reciclado</option></select></div>
        <div class="col-md-3"><input type="file" id="foto" accept="image/*" class="form-control"></div>
        <div class="col-md-2"><input type="number" id="qtd" class="form-control" placeholder="Qtd kg" step="0.1"></div>
        <div class="col-md-2"><button class="btn btn-success w-100" onclick="add()">Adicionar</button></div>
      </div>
      <div class="mt-3">
        <input type="file" id="importExcel" accept=".xlsx" class="form-control">
        <button class="btn btn-warning mt-2" onclick="importarExcel()">Importar Excel</button>
        <button class="btn btn-info mt-2" onclick="exportarExcel()">Exportar Excel</button>
      </div>
    </div>

    <div id="lista" class="row g-4"></div>
  </div>

  <script>
    if(!sessionStorage.getItem('logado')) location.href='index.html';
    function add(){
      const nome = document.getElementById('nome').value.trim();
      const tipo = document.getElementById('tipo').value;
      const qtd = parseFloat(document.getElementById('qtd').value)||0;
      const file = document.getElementById('foto').files[0];
      if(!nome || qtd<=0) return alert('Preencha nome e quantidade!');
      const reader = new FileReader();
      reader.onload = function(e){
        let mp = JSON.parse(localStorage.getItem('materias')||'[]');
        const existente = mp.find(m=>m.nome===nome);
        if(existente){
          existente.estoque += qtd;
          if(e.target.result) existente.foto = e.target.result;
        } else {
          mp.push({nome,tipo,estoque:qtd,foto:e.target.result||''});
        }
        localStorage.setItem('materias',JSON.stringify(mp));
        listar();
      };
      if(file) reader.readAsDataURL(file);
      else reader.onload({target:{result:''}});
    }
    function listar(){
      const lista = document.getElementById('lista');
      const mp = JSON.parse(localStorage.getItem('materias')||'[]');
      lista.innerHTML = '';
      mp.forEach((m,i)=>{
        lista.innerHTML += `
          <div class="col-md-4">
            <div class="card bg-dark text-white">
              ${m.foto?`<img src="${m.foto}" class="card-img-top" style="height:200px;object-fit:cover">`:''}
              <div class="card-body">
                <h5>${m.nome} (${m.tipo})</h5>
                <p class="text-success fs-4">${m.estoque.toFixed(1)} kg</p>
                <button class="btn btn-danger btn-sm" onclick="remover(${i})">Remover</button>
              </div>
            </div>
          </div>`;
      });
    }
    function remover(i){
      if(confirm('Remover?')){
        let mp = JSON.parse(localStorage.getItem('materias'));
        mp.splice(i,1);
        localStorage.setItem('materias',JSON.stringify(mp));
        listar();
      }
    }
    function exportarExcel(){
      const mp = JSON.parse(localStorage.getItem('materias')||'[]');
      const ws = XLSX.utils.json_to_sheet(mp.map(m=>({Nome:m.nome,Tipo:m.tipo,Estoque:m.estoque})));
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Materias");
      XLSX.writeFile(wb,"materia_prima.xlsx");
    }
    function importarExcel(){
      const file = document.getElementById('importExcel').files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e){
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data,{type:'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);
        localStorage.setItem('materias',JSON.stringify(json));
        listar();
      };
      reader.readAsArrayBuffer(file);
    }
    listar();
  </script>
</body>
</html>
